<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JasDo IT e-commerce</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="product_style.css">
</head>
<body>

<header>
    <h1>JasDo IT</h1>
    <nav>
        <a href="index.html">Home</a>
        <a href="account.html">My Account</a>
        <a href="login.html" id="loginBtn">Login</a>
        <a href="Sign-New.html" id="signupBtn">Sign Up</a>
        <a href="product_add.html" id="Product add">Add Product</a>
    </nav>
</header>

<section class="search-bar">
    <input type="text" id="searchInput" placeholder="Search products...">
    <button onclick="searchProducts()">Search</button>
</section>

<section id="productGrid" class="product-grid">
    <!-- Products will be dynamically loaded here -->
</section>

<script>
    const backendUrl = "http://localhost:8080"; // Change if needed
    const userId = localStorage.getItem("userId"); // get logged-in user id

    // Load all products
    async function loadProducts() {
        try {
            let res = await fetch(`${backendUrl}/api/products/all-products`);
            if (!res.ok) throw new Error("Failed to fetch products");
            let products = await res.json();
            displayProducts(products);
        } catch (err) {
            console.error(err);
        }
    }

    async function searchProducts() {
        const query = document.getElementById("searchInput").value;

        const response = await fetch(`${backendUrl}/api/products/search?keyword=${query}`);
        const products = await response.json();

        console.log("Products found: ", products);

        // reuse displayProducts instead of duplicating rendering
        displayProducts(products);
    }

    // Display products in grid
    function displayProducts(products) {
        const grid = document.getElementById("productGrid");
        grid.innerHTML = "";

        if (products.length === 0) {
            grid.innerHTML = "<p>No products found.</p>";
            return;
        }

        products.forEach(p => {
            const firstImage = (p.images && p.images.length > 0)
                ? `${backendUrl}/api/products/product/${p.images[0].id}/images`
                : "placeholder.jpg";

            grid.innerHTML += `
            <div class="product-card">
                <img src="${firstImage}" alt="${p.name}">
                <h3>${p.name}</h3>
                <p>${p.description ? p.description.substring(0, 60) : ""}...</p>
                <p class="price">$${p.price}</p>
                <button onclick="viewDetails(${p.id})">View Details</button>
                <button onclick="addToCart(${p.id})">Add to Cart ðŸ›’</button>
            </div>
        `;
        });
    }

    // Navigate to product details
    function viewDetails(id) {
        window.location.href = `product-details.html?id=${id}`;
    }

    // Add product to cart
    async function addToCart(productId) {
        if (!userId) {
            alert("Please login to add items to cart!");
            window.location.href = "login.html";
            return;
        }

        try {
            let res = await fetch(`${backendUrl}/api/cart/add?userId=${userId}&productId=${productId}&quantity=1`, {
                method: "POST"
            });

            if (!res.ok) throw new Error("Failed to add to cart");

            let data = await res.json();
            alert("Product added to cart!");
            console.log("Cart updated:", data);
        } catch (err) {
            console.error(err);
            alert("Error adding to cart");
        }
    }

    // Initial load
    loadProducts();

</script>

</body>
</html>
